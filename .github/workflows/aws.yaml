# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Amazon ECRì— ìƒˆ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  í‘¸ì‹œí•˜ë©°, 
# ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ Amazon ECSì— ìƒˆ ì‘ì—… ì •ì˜ë¥¼ ë°°í¬í•©ë‹ˆë‹¤.
#
# ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ ì„¤ì • ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤:
#
# 1. ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ECR ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•˜ì„¸ìš”.
#    ì˜ˆ: `aws ecr create-repository --repository-name my-ecr-repo --region us-east-2`.
#    ì•„ë˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ `ECR_REPOSITORY` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
#    `AWS_REGION` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ ë¦¬í¬ì§€í† ë¦¬ì˜ ë¦¬ì „ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
#
# 2. ECS ì‘ì—… ì •ì˜, ECS í´ëŸ¬ìŠ¤í„° ë° ECS ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.
#    ì˜ˆ: ECS ì½˜ì†”ì˜ ì‹œì‘ ê°€ì´ë“œ ì°¸ì¡°:
#      https://us-east-2.console.aws.amazon.com/ecs/home?region=us-east-2#/firstRun
#    ì•„ë˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ `ECS_SERVICE` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ Amazon ECS ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
#    `ECS_CLUSTER` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ í´ëŸ¬ìŠ¤í„° ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
#
# 3. ECS ì‘ì—… ì •ì˜ë¥¼ JSON íŒŒì¼ë¡œ ë¦¬í¬ì§€í† ë¦¬ì— ì €ì¥í•˜ì„¸ìš”.
#    í˜•ì‹ì€ `aws ecs register-task-definition --generate-cli-skeleton` ëª…ë ¹ì–´ì˜ ì¶œë ¥ ê²°ê³¼ì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.
#    ì•„ë˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ `ECS_TASK_DEFINITION` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ JSON íŒŒì¼ ê²½ë¡œë¡œ ë°”ê¾¸ì„¸ìš”.
#    `CONTAINER_NAME` í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ ì‘ì—… ì •ì˜ì˜ `containerDefinitions` ì„¹ì…˜ì— ìˆëŠ” ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
#
# 4. IAM ì‚¬ìš©ì ì•¡ì„¸ìŠ¤ í‚¤ë¥¼ GitHub Actions ë¹„ë°€ ë³€ìˆ˜ì— ì €ì¥í•˜ì„¸ìš”: 
#    `AWS_ACCESS_KEY_ID` ë° `AWS_SECRET_ACCESS_KEY`.
#    ì‚¬ìš©ëœ ê° ì•¡ì…˜ì˜ ê¶Œì¥ IAM ì •ì±… ë° ì•¡ì„¸ìŠ¤ í‚¤ ìê²© ì¦ëª…ì„ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì€ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

name: AWS ECRì— ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

on:
  push:
    branches:
      - feature/release-test

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}                   # ì„ í˜¸í•˜ëŠ” AWS ë¦¬ì „ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”. ì˜ˆ: us-west-1
  FRONTEND_ECR_NAME: ${{ secrets.FRONTEND_ECR_NAME }}          # Amazon ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
  BACKEND_ECR_NAME: ${{ secrets.BACKEND_ECR_NAME }}          # Amazon ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
#  ECS_SERVICE: MY_ECS_SERVICE                 # Amazon ECS ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
#  ECS_CLUSTER: MY_ECS_CLUSTER                 # Amazon ECS í´ëŸ¬ìŠ¤í„° ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
#  ECS_TASK_DEFINITION: MY_ECS_TASK_DEFINITION # Amazon ECS ì‘ì—… ì •ì˜ íŒŒì¼ ê²½ë¡œë¡œ ì„¤ì •í•˜ì„¸ìš”. 
#                                               # ì˜ˆ: .aws/task-definition.json
#  CONTAINER_NAME: MY_CONTAINER_NAME           # ì‘ì—… ì •ì˜ì˜ containerDefinitions ì„¹ì…˜ì— ìˆëŠ” ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'test' }} # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œ ë°°í¬ ê·¸ ì™¸ì—ëŠ” í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë°°í¬
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v2

      - name: AWS ìê²© ì¦ëª… êµ¬ì„±
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          touch ./frontend/.env
          echo "${{ secrets.FRONTEND_SECRET }}" >> ./frontend/.env

      - name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: "${{ github.sha }}"
        run: |
          echo "ğŸ“¦ ${{ matrix.service }} ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì‹œì‘"
          if [ "$matrix.service" == "frontend" ]; then
            echo "$ECR_REGISTRY/$FRONTEND_ECR_NAME:$IMAGE_TAG"
            docker build -t $ECR_REGISTRY/$FRONTEND_ECR_NAME:$IMAGE_TAG -f ./${{ matrix.service }}/Dockerfile ./${{ matrix.service }}
            docker push $ECR_REGISTRY/$FRONTEND_ECR_NAME:$IMAGE_TAG
          else
            echo "$ECR_REGISTRY/$BACKEND_ECR_NAME:$IMAGE_TAG"
            docker build -t $ECR_REGISTRY/$BACKEND_ECR_NAME:$IMAGE_TAG -f ./${{ matrix.service }}/Dockerfile ./${{ matrix.service }}
            docker push $ECR_REGISTRY/$BACKEND_ECR_NAME:$IMAGE_TAG
          fi
          echo "ğŸ“¦ ${{ matrix.service }} ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"

#    - name: Amazon ECS ì‘ì—… ì •ì˜ì— ìƒˆ ì´ë¯¸ì§€ ID ì…ë ¥
#      id: task-def
#      uses: aws-actions/amazon-ecs-render-task-definition@v1
#      with:
#        task-definition: ${{ env.ECS_TASK_DEFINITION }}
#        container-name: ${{ env.CONTAINER_NAME }}
#        image: ${{ steps.build-image.outputs.image }}
#
#    - name: Amazon ECS ì‘ì—… ì •ì˜ ë°°í¬
#      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
#      with:
#        task-definition: ${{ steps.task-def.outputs.task-definition }}
#        service: ${{ env.ECS_SERVICE }}
#        cluster: ${{ env.ECS_CLUSTER }}
#        wait-for-service-stability: true