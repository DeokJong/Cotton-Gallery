name: AWS ECRì— ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

on:
  push:
    branches:
      - feature/release-test

env:
  AWS_REGION: ap-northeast-2                   # ì„ í˜¸í•˜ëŠ” AWS ë¦¬ì „ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”. ì˜ˆ: us-west-1
  ECR_REPOSITORY: jbnu-shopping/image          # Amazon ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
  BACKEND_DOCKERFILE_PATH: ./backend/Dockerfile # ë°±ì—”ë“œ Dockerfile ê²½ë¡œ
  BACKEND_BUILD_CONTEXT: ./backend             # ë°±ì—”ë“œ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸
  FRONTEND_DOCKERFILE_PATH: ./frontend/Dockerfile # í”„ë¡ íŠ¸ì—”ë“œ Dockerfile ê²½ë¡œ
  FRONTEND_BUILD_CONTEXT: ./frontend           # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸

#  ECS_SERVICE: MY_ECS_SERVICE                 # Amazon ECS ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
#  ECS_CLUSTER: MY_ECS_CLUSTER                 # Amazon ECS í´ëŸ¬ìŠ¤í„° ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
#  ECS_TASK_DEFINITION: MY_ECS_TASK_DEFINITION # Amazon ECS ì‘ì—… ì •ì˜ íŒŒì¼ ê²½ë¡œë¡œ ì„¤ì •í•˜ì„¸ìš”. 
#                                               # ì˜ˆ: .aws/task-definition.json
#  CONTAINER_NAME: MY_CONTAINER_NAME           # ì‘ì—… ì •ì˜ì˜ containerDefinitions ì„¹ì…˜ì— ìˆëŠ” ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.

jobs:
  deploy:
    name: ë°°í¬
    runs-on: ubuntu-latest
    environment: test

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v2

    - name: AWS ìê²© ì¦ëª… êµ¬ì„±
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Amazon ECR ë¡œê·¸ì¸
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Docker Buildx í™œì„±í™”
      uses: docker/setup-buildx-action@v2
      with:
        driver-opts: image=moby/buildkit:latest

    - name: Docker ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬ - ë°±ì—”ë“œ
      run: |
        echo "ğŸ“¦ Docker ë°±ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ìœ íš¨ì„± ê²€ì‚¬"
        if ! docker manifest inspect $ECR_REGISTRY/$ECR_REPOSITORY:backend-cache > /dev/null 2>&1; then
          echo "âš ï¸ ë°±ì—”ë“œ ìºì‹œ ë ˆì´ì–´ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
          docker buildx build \
            --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:backend-cache,mode=max \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:backend-init-cache \
            --push -f ${{ env.BACKEND_DOCKERFILE_PATH }} ${{ env.BACKEND_BUILD_CONTEXT }}
          echo "ğŸš€ ë°±ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ìƒì„± ì™„ë£Œ"
        else
          echo "âœ… ê¸°ì¡´ ë°±ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ë°œê²¬, ìºì‹œ ì‚¬ìš© ì¤€ë¹„ ì™„ë£Œ"
        fi

    - name: Docker ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬ - í”„ë¡ íŠ¸ì—”ë“œ
      run: |
        echo "ğŸ“¦ Docker í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ìœ íš¨ì„± ê²€ì‚¬"
        if ! docker manifest inspect $ECR_REGISTRY/$ECR_REPOSITORY:frontend-cache > /dev/null 2>&1; then
          echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ ë ˆì´ì–´ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
          docker buildx build \
            --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:frontend-cache,mode=max \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:frontend-init-cache \
            --push -f ${{ env.FRONTEND_DOCKERFILE_PATH }} ${{ env.FRONTEND_BUILD_CONTEXT }}
          echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ìƒì„± ì™„ë£Œ"
        else
          echo "âœ… ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ ë ˆì´ì–´ ë°œê²¬, ìºì‹œ ì‚¬ìš© ì¤€ë¹„ ì™„ë£Œ"
        fi

    - name: Amazon ECRì— ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ ì§€ì • ë° í‘¸ì‹œ
      id: build-backend-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        BACKEND_IMAGE_TAG: "${{ github.sha }}-backend"
      run: |
        echo "ğŸ“¦ ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì‹œì‘"
        docker buildx build \
        --cache-from type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:backend-cache \
        --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:backend-cache,mode=max \
        -t $ECR_REGISTRY/$ECR_REPOSITORY:$BACKEND_IMAGE_TAG \
        -f ${{ env.BACKEND_DOCKERFILE_PATH }} ${{ env.BACKEND_BUILD_CONTEXT }} --push
        echo "ğŸš€ ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$BACKEND_IMAGE_TAG"

    - name: Amazon ECRì— í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ ì§€ì • ë° í‘¸ì‹œ
      id: build-frontend-image
      env:  
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        FRONTEND_IMAGE_TAG: "${{ github.sha }}-frontend"
      run: |
        echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì‹œì‘"
        docker buildx build \
        --cache-from type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:frontend-cache \
        --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:frontend-cache,mode=max \
        -t $ECR_REGISTRY/$ECR_REPOSITORY:$FRONTEND_IMAGE_TAG \
        -f ${{ env.FRONTEND_DOCKERFILE_PATH }} ${{ env.FRONTEND_BUILD_CONTEXT }} --push
        echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$FRONTEND_IMAGE_TAG"

#    - name: Amazon ECS ì‘ì—… ì •ì˜ì— ìƒˆ ì´ë¯¸ì§€ ID ì…ë ¥
#      id: task-def
#      uses: aws-actions/amazon-ecs-render-task-definition@v1
#      with:
#        task-definition: ${{ env.ECS_TASK_DEFINITION }}
#        container-name: ${{ env.CONTAINER_NAME }}
#        image: ${{ steps.build-image.outputs.image }}
#
#    - name: Amazon ECS ì‘ì—… ì •ì˜ ë°°í¬
#      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
#      with:
#        task-definition: ${{ steps.task-def.outputs.task-definition }}
#        service: ${{ env.ECS_SERVICE }}
#        cluster: ${{ env.ECS_CLUSTER }}
#        wait-for-service-stability: true
